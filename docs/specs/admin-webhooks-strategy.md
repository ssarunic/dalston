# Admin-Registered Webhooks: Strategy

## Problem Statement

Dalston currently supports webhooks only as per-job parameters: the caller passes a
`webhook_url` when submitting a transcription job. This works but has two structural
problems:

1. **Security exposure.** Every API caller can direct webhook traffic to any URL they
   choose. The SSRF protections we added in M05 (private-IP blocking, HMAC signing)
   mitigate the worst cases, but the fundamental issue remains: the attack surface is
   the entire internet. Any caller with a `jobs:write` API key can point webhooks at
   arbitrary third-party endpoints, potentially using Dalston as a traffic amplifier
   or probing tool. An admin-registered allowlist reduces the surface to a controlled
   set of verified endpoints.

2. **ElevenLabs API incompatibility.** The ElevenLabs Speech-to-Text API does not
   accept `webhook_url` as a submission parameter. Our per-job approach is a Dalston
   extension that breaks strict compatibility on the `/v1/speech-to-text/*` path. Any
   customer integrating via an ElevenLabs SDK or expecting exact API parity will not
   be able to use webhooks at all.

A secondary concern is **operational reliability**. Per-job webhooks are fire-and-forget
from the caller's perspective — there is no way to inspect delivery history, replay
failed deliveries, or audit which URLs have been contacted. The retry logic is in-memory
in the orchestrator; a crash loses pending retries silently.

## Why Now

- M17 (API Key Management) shipped the `webhooks` auth scope but nothing uses it yet.
  The permission model is ready; the feature behind it is not.
- Customers self-hosting Dalston are asking for webhook notifications without having to
  change their transcription submission code (which may be generated by an SDK).
- We want to keep the ElevenLabs-compatible path clean. Adding Dalston-specific form
  fields to `/v1/speech-to-text/transcriptions` would entrench the incompatibility.

## Desired Outcomes

### 1. Admin-controlled webhook endpoints

Admins (users with `webhooks` or `admin` scope) register webhook endpoints ahead of
time. Each endpoint specifies:

- A URL to receive callbacks
- Which event types to subscribe to
- An optional description for operational clarity

Endpoints are scoped to a tenant. Only admins for that tenant can create, modify, or
delete them. Registration is a separate concern from job submission — callers never
need to (and cannot) specify URLs inline.

### 2. Event-driven fan-out

When a relevant event fires (e.g., `transcription.completed`), the system delivers
to **all** matching registered endpoints for that tenant, not just a single URL. This
supports use cases where multiple downstream systems need notifications (analytics
pipeline, user notification service, billing system).

### 3. Delivery observability

Every delivery attempt is logged with its outcome: HTTP status, latency, error
message. Admins can query delivery history for an endpoint and manually retry specific
failed deliveries. This replaces the current fire-and-forget model.

### 4. Backward compatibility

Per-job `webhook_url` continues to work on the Dalston-native path
(`/v1/audio/transcriptions`). It is treated as an additional one-shot endpoint for
that specific job, on top of any registered endpoints. The ElevenLabs-compatible path
gains webhook support implicitly — registering an endpoint is enough; no changes to
submission calls are needed.

### 5. Secure by default

- Registered endpoints undergo the same SSRF validation as today (private-IP blocking).
- Each endpoint gets its own signing secret, generated server-side. Admins retrieve it
  once at creation time (like an API key). This eliminates the shared
  `WEBHOOK_SECRET` env var as a single point of compromise.
- The per-job `webhook_url` parameter is deprecated on new deployments and can be
  disabled via configuration, pushing users toward the more secure registered model.

## What This Is Not

- **Not a general-purpose event bus.** We are not building pub/sub infrastructure.
  Webhooks are HTTP POST callbacks for a defined set of Dalston job lifecycle events.
- **Not a replacement for polling.** Polling (`GET /v1/audio/transcriptions/{id}`) is
  still the primary, guaranteed way to get results. Webhooks are best-effort
  notifications that reduce polling frequency.
- **Not multi-tenant webhook routing.** Endpoints are scoped to the tenant that
  creates them. There is no cross-tenant webhook federation.

## Success Criteria

| Criterion | Measure |
|-----------|---------|
| Admin can CRUD webhook endpoints | API endpoints exist, tested, documented |
| Transcription events fan out to all matching endpoints | Integration test with 2+ endpoints |
| Delivery logs are queryable | Admin can list attempts per endpoint with status |
| Per-job webhooks still work | Existing M05 tests pass unchanged |
| ElevenLabs path gets webhooks without API changes | Job submitted via `/v1/speech-to-text/*` triggers registered webhooks |
| Per-endpoint signing secrets | Each endpoint has its own HMAC secret |
| Delivery survives orchestrator restart | Pending deliveries are persisted in Redis or Postgres |
