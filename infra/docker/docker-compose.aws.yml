# Docker Compose override for AWS deployment
# Usage: docker compose -f docker-compose.yml -f infra/docker/docker-compose.aws.yml up -d --profile local-infra --profile gpu

services:
  gateway:
    environment:
      DALSTON_S3_BUCKET: ${DALSTON_S3_BUCKET}
      DALSTON_S3_REGION: ${DALSTON_S3_REGION}
      AWS_REGION: ${AWS_REGION}
      DALSTON_S3_PUBLIC_ENDPOINT_URL: ${DALSTON_S3_PUBLIC_ENDPOINT_URL:-}
      # No S3_ENDPOINT - SDK auto-detects on EC2
      # No credentials - uses IAM instance role
    # Bind to all interfaces for Tailscale access
    ports:
      - "8000:8000"

  orchestrator:
    environment:
      DALSTON_S3_BUCKET: ${DALSTON_S3_BUCKET}
      DALSTON_S3_REGION: ${DALSTON_S3_REGION}
      AWS_REGION: ${AWS_REGION}

  postgres:
    volumes:
      - /data/postgres:/var/lib/postgresql/data

  redis:
    volumes:
      - /data/redis:/data

  stt-batch-prepare:
    environment:
      DALSTON_S3_BUCKET: ${DALSTON_S3_BUCKET}
      DALSTON_S3_REGION: ${DALSTON_S3_REGION}
      AWS_REGION: ${AWS_REGION}

  stt-batch-transcribe-faster-whisper-base:
    environment:
      DALSTON_S3_BUCKET: ${DALSTON_S3_BUCKET}
      DALSTON_S3_REGION: ${DALSTON_S3_REGION}
      AWS_REGION: ${AWS_REGION}
      HF_HOME: /data/models
    volumes:
      - /data/models:/data/models

  stt-batch-transcribe-parakeet-ctc-0.6b:
    environment:
      DALSTON_S3_BUCKET: ${DALSTON_S3_BUCKET}
      DALSTON_S3_REGION: ${DALSTON_S3_REGION}
      AWS_REGION: ${AWS_REGION}
      HF_HOME: /data/models
      NEMO_CACHE: /data/models
    volumes:
      - /data/models:/data/models

  stt-batch-align-whisperx:
    environment:
      DALSTON_S3_BUCKET: ${DALSTON_S3_BUCKET}
      DALSTON_S3_REGION: ${DALSTON_S3_REGION}
      AWS_REGION: ${AWS_REGION}
      HF_HOME: /data/models
    volumes:
      - /data/models:/data/models

  stt-batch-diarize-pyannote-3.1:
    environment:
      DALSTON_S3_BUCKET: ${DALSTON_S3_BUCKET}
      DALSTON_S3_REGION: ${DALSTON_S3_REGION}
      AWS_REGION: ${AWS_REGION}
      HF_HOME: /data/models
    volumes:
      - /data/models:/data/models

  stt-batch-pii-detect-presidio-gpu:
    environment:
      DALSTON_S3_BUCKET: ${DALSTON_S3_BUCKET}
      DALSTON_S3_REGION: ${DALSTON_S3_REGION}
      AWS_REGION: ${AWS_REGION}
      HF_HOME: /data/models
    volumes:
      - /data/models:/data/models

  stt-batch-merge:
    environment:
      DALSTON_S3_BUCKET: ${DALSTON_S3_BUCKET}
      DALSTON_S3_REGION: ${DALSTON_S3_REGION}
      AWS_REGION: ${AWS_REGION}

  stt-rt-transcribe-parakeet-rnnt-0.6b:
    environment:
      DALSTON_S3_BUCKET: ${DALSTON_S3_BUCKET}
      DALSTON_S3_REGION: ${DALSTON_S3_REGION}
      AWS_REGION: ${AWS_REGION}
      HF_HOME: /data/models
      NEMO_CACHE: /data/models
    volumes:
      - /data/models:/data/models

# Exclude MinIO services - using S3 instead
# The base docker-compose.yml may define minio and minio-init
# but they won't be started unless explicitly included
